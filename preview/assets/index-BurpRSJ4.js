import{invoke as d,Channel as q}from"./core-CKq3Z5BB.js";const c="Request cancelled";async function U(p,e){const n=e?.signal;if(n?.aborted)throw new Error(c);const w=e?.maxRedirections,g=e?.connectTimeout,m=e?.proxy,b=e?.danger;e&&(delete e.maxRedirections,delete e.connectTimeout,delete e.proxy,delete e.danger);const s=e?.headers?e.headers instanceof Headers?e.headers:new Headers(e.headers):new Headers,a=new Request(p,e),f=await a.arrayBuffer(),R=f.byteLength!==0?Array.from(new Uint8Array(f)):null;for(const[r,t]of a.headers)s.get(r)||s.set(r,t);const A=(s instanceof Headers?Array.from(s.entries()):Array.isArray(s)?s:Object.entries(s)).map(([r,t])=>[r,typeof t=="string"?t:t.toString()]);if(n?.aborted)throw new Error(c);const l=await d("plugin:http|fetch",{clientConfig:{method:a.method,url:a.url,headers:A,data:R,maxRedirections:w,connectTimeout:g,proxy:m,danger:b}}),y=()=>d("plugin:http|fetch_cancel",{rid:l});if(n?.aborted)throw y(),new Error(c);n?.addEventListener("abort",()=>void y());const{status:i,statusText:E,url:x,headers:H,rid:L}=await d("plugin:http|fetch_send",{rid:l}),_=[101,103,204,205,304].includes(i)?null:new ReadableStream({start:r=>{const t=new q;t.onmessage=u=>{if(n?.aborted){r.error(c);return}const o=new Uint8Array(u),C=o[o.byteLength-1],T=o.slice(0,o.byteLength-1);if(C==1){r.close();return}r.enqueue(T)},d("plugin:http|fetch_read_body",{rid:L,streamChannel:t}).catch(u=>{r.error(u)})}}),h=new Response(_,{status:i,statusText:E});return Object.defineProperty(h,"url",{value:x}),Object.defineProperty(h,"headers",{value:new Headers(H)}),h}export{U as fetch};
